<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Moldes STL</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            padding: 15px; 
        }
        .container { 
            background: rgba(255, 255, 255, 0.95); 
            border-radius: 20px; 
            padding: 25px; 
            max-width: 600px; 
            width: 100%; 
            text-align: center; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
        }
        h1 { color: #333; margin-bottom: 15px; font-size: 1.8em; }
        .status { 
            background: rgba(33, 150, 243, 0.1); 
            padding: 10px; 
            border-radius: 10px; 
            margin-bottom: 20px; 
            color: #1976d2; 
            font-weight: bold; 
        }
        .upload { 
            border: 3px dashed #667eea; 
            border-radius: 15px; 
            padding: 30px 15px; 
            margin: 20px 0; 
            cursor: pointer; 
            background: rgba(102, 126, 234, 0.05); 
            transition: all 0.3s; 
            position: relative; 
        }
        .upload:hover { 
            border-color: #764ba2; 
            background: rgba(118, 75, 162, 0.1); 
            transform: translateY(-2px); 
        }
        .upload input { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            opacity: 0; 
            cursor: pointer; 
        }
        .controls { 
            display: none; 
            margin: 20px 0; 
            padding: 15px; 
            background: rgba(102, 126, 234, 0.1); 
            border-radius: 10px; 
            text-align: left; 
        }
        .control { 
            margin: 15px 0; 
        }
        .control label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: bold; 
            color: #333; 
            font-size: 0.9em; 
        }
        .control-row { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            flex-wrap: wrap; 
        }
        input[type="range"] { 
            flex: 1; 
            min-width: 150px; 
            height: 30px; 
        }
        input[type="number"] { 
            width: 70px; 
            padding: 5px; 
            border: 2px solid #ddd; 
            border-radius: 5px; 
            text-align: center; 
            font-size: 0.9em; 
        }
        .btn { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border: none; 
            padding: 12px 25px; 
            border-radius: 20px; 
            font-size: 1em; 
            cursor: pointer; 
            margin: 8px 0; 
            width: 100%; 
            max-width: 280px; 
            transition: all 0.3s; 
            font-weight: bold; 
        }
        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); 
        }
        .btn:disabled { 
            opacity: 0.6; 
            cursor: not-allowed; 
            transform: none; 
        }
        .result { 
            display: none; 
            margin: 20px 0; 
            padding: 15px; 
            background: rgba(76, 175, 80, 0.1); 
            border-radius: 10px; 
            border: 2px solid #4caf50; 
        }
        .result h3 { 
            color: #2e7d32; 
            margin-bottom: 10px; 
        }
        .error { 
            display: none; 
            margin: 15px 0; 
            padding: 10px; 
            background: rgba(244, 67, 54, 0.1); 
            border: 2px solid #f44336; 
            border-radius: 8px; 
            color: #d32f2f; 
            font-size: 0.9em; 
            font-weight: bold; 
        }
        .info { 
            background: rgba(76, 175, 80, 0.1); 
            padding: 10px; 
            border-radius: 8px; 
            margin: 10px 0; 
            font-size: 0.85em; 
            color: #2e7d32; 
            text-align: left; 
        }
        .progress { 
            display: none; 
            margin: 15px 0; 
        }
        .progress-bar { 
            width: 100%; 
            height: 8px; 
            background: #e0e0e0; 
            border-radius: 4px; 
            overflow: hidden; 
            margin-bottom: 8px; 
        }
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            width: 0%; 
            transition: width 0.3s; 
        }
        @media (max-width: 480px) {
            .container { padding: 20px; margin: 10px; }
            h1 { font-size: 1.6em; }
            .upload { padding: 25px 10px; }
            .control-row { flex-direction: column; gap: 8px; align-items: stretch; }
            input[type="range"] { min-width: 100%; }
            input[type="number"] { width: 100px; align-self: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè≠ Generador de Moldes STL</h1>
        <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">
            Genera moldes reales para impresi√≥n 3D con encastres autom√°ticos
        </p>

        <div class="status" id="status">
            üì± Funciona en m√≥vil y desktop | ‚úÖ Versi√≥n corregida
        </div>

        <div class="upload" id="uploadArea">
            <div style="font-size: 2.5em; margin-bottom: 10px; color: #667eea;">üìÅ</div>
            <div style="font-weight: bold; margin-bottom: 5px;" id="uploadText">
                Toca para seleccionar archivo STL
            </div>
            <div style="font-size: 0.8em; color: #999;">
                Archivos .stl hasta 25MB
            </div>
            <input type="file" id="fileInput" accept=".stl" />
        </div>

        <div class="controls" id="controls">
            <h3 style="text-align: center; margin-bottom: 15px; color: #333;">
                ‚öôÔ∏è Configuraci√≥n del Molde
            </h3>
            
            <div class="control">
                <label>Grosor de Paredes del Molde:</label>
                <div class="control-row">
                    <input type="range" id="wallThickness" min="2" max="15" value="5" step="0.5">
                    <input type="number" id="wallValue" min="2" max="15" value="5" step="0.5">
                    <span style="font-size: 0.8em; color: #666;">mm</span>
                </div>
            </div>

            <div class="control">
                <label>Tolerancia para Desmoldeo:</label>
                <div class="control-row">
                    <input type="range" id="tolerance" min="0.2" max="3" value="0.8" step="0.1">
                    <input type="number" id="toleranceValue" min="0.2" max="3" value="0.8" step="0.1">
                    <span style="font-size: 0.8em; color: #666;">mm</span>
                </div>
            </div>

            <div class="control">
                <label>Tama√±o de Encastres:</label>
                <div class="control-row">
                    <input type="range" id="keySize" min="4" max="20" value="10" step="1">
                    <input type="number" id="keySizeValue" min="4" max="20" value="10" step="1">
                    <span style="font-size: 0.8em; color: #666;">mm</span>
                </div>
            </div>

            <div class="control">
                <label>Espaciado entre Encastres:</label>
                <div class="control-row">
                    <input type="range" id="keySpacing" min="20" max="80" value="40" step="5">
                    <input type="number" id="keySpacingValue" min="20" max="80" value="40" step="5">
                    <span style="font-size: 0.8em; color: #666;">mm</span>
                </div>
            </div>
        </div>

        <div class="progress" id="progress">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="progressText" style="font-size: 0.9em; color: #666; font-weight: bold;">
                Procesando molde...
            </div>
        </div>

        <div class="error" id="errorMsg"></div>

        <div class="result" id="result">
            <h3>‚úÖ ¬°Molde Generado Correctamente!</h3>
            <p style="margin-bottom: 15px; color: #2e7d32;">
                Se ha creado un molde real basado en tu archivo STL
            </p>
            <button class="btn" onclick="downloadMold('completo')">
                üì• Descargar Molde Completo (.stl)
            </button>
            <button class="btn" onclick="downloadMold('superior')">
                üì• Descargar Parte Superior (.stl)
            </button>
            <button class="btn" onclick="downloadMold('inferior')">
                üì• Descargar Parte Inferior (.stl)
            </button>
        </div>

        <button class="btn" id="generateBtn" style="display: none;">
            üîß Generar Molde Real
        </button>
    </div>

    <script>
        // Detecci√≥n de dispositivo
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                         ('ontouchstart' in window);

        // Variables globales
        let uploadedFile = null;
        let stlGeometry = null;
        let moldData = null;

        // Referencias DOM
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const controls = document.getElementById('controls');
        const generateBtn = document.getElementById('generateBtn');
        const progress = document.getElementById('progress');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const result = document.getElementById('result');
        const errorMsg = document.getElementById('errorMsg');
        const status = document.getElementById('status');
        const uploadText = document.getElementById('uploadText');

        // Actualizar texto seg√∫n dispositivo
        if (isMobile) {
            status.textContent = 'üì± Optimizado para m√≥vil | ‚úÖ Versi√≥n corregida';
            uploadText.textContent = 'Toca para seleccionar archivo STL';
        } else {
            status.textContent = 'üñ•Ô∏è Versi√≥n desktop | ‚úÖ Drag & drop disponible';
            uploadText.textContent = 'Arrastra tu STL aqu√≠ o haz clic';
        }

        // Sincronizar controles
        function syncControls() {
            const pairs = [
                ['wallThickness', 'wallValue'],
                ['tolerance', 'toleranceValue'], 
                ['keySize', 'keySizeValue'],
                ['keySpacing', 'keySpacingValue']
            ];

            pairs.forEach(([sliderId, inputId]) => {
                const slider = document.getElementById(sliderId);
                const input = document.getElementById(inputId);
                
                slider.addEventListener('input', () => input.value = slider.value);
                input.addEventListener('input', () => slider.value = input.value);
            });
        }

        // Configurar eventos
        function setupEvents() {
            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelect);
            generateBtn.addEventListener('click', generateMold);

            // Drag & drop para desktop
            if (!isMobile) {
                uploadArea.addEventListener('dragover', handleDragOver);
                uploadArea.addEventListener('dragleave', handleDragLeave);
                uploadArea.addEventListener('drop', handleDrop);
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.style.borderColor = '#764ba2';
            uploadArea.style.background = 'rgba(118, 75, 162, 0.15)';
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.style.borderColor = '#667eea';
            uploadArea.style.background = 'rgba(102, 126, 234, 0.05)';
        }

        function handleDrop(e) {
            e.preventDefault();
            handleDragLeave(e);
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) processFile(file);
        }

        async function processFile(file) {
            // Validaciones
            if (!file.name.toLowerCase().endsWith('.stl')) {
                showError('‚ùå Selecciona un archivo STL v√°lido');
                return;
            }

            if (file.size > 25 * 1024 * 1024) {
                showError('‚ùå Archivo muy grande (m√°ximo 25MB)');
                return;
            }

            uploadedFile = file;
            
            try {
                showProgress(20, 'üìñ Leyendo archivo STL...');
                
                const buffer = await file.arrayBuffer();
                
                showProgress(40, 'üîç Analizando geometr√≠a...');
                stlGeometry = await parseSTL(buffer);
                
                showProgress(60, 'üìê Calculando dimensiones...');
                const stats = calculateStats(stlGeometry);
                
                showProgress(80, '‚úÖ Archivo procesado');
                
                // Actualizar UI
                uploadArea.innerHTML = `
                    <div style="font-size: 2em; color: #4caf50; margin-bottom: 10px;">‚úÖ</div>
                    <div style="font-weight: bold; margin-bottom: 8px;">${file.name}</div>
                    <div style="font-size: 0.8em; color: #666; margin-bottom: 10px;">
                        ${(file.size / 1024 / 1024).toFixed(2)} MB
                    </div>
                    <div class="info">
                        <strong>üìä An√°lisis del STL:</strong><br>
                        üî∫ Tri√°ngulos: ${stats.triangles.toLocaleString()}<br>
                        üìè Dimensiones: ${stats.width} √ó ${stats.height} √ó ${stats.depth} mm<br>
                        üíæ Volumen: ${stats.volume} cm¬≥
                    </div>
                `;

                controls.style.display = 'block';
                generateBtn.style.display = 'block';
                hideError();
                hideResult();
                hideProgress();

            } catch (error) {
                showError('‚ùå Error procesando STL: ' + error.message);
                hideProgress();
            }
        }

        async function parseSTL(buffer) {
            return new Promise((resolve, reject) => {
                try {
                    const dataView = new DataView(buffer);
                    
                    // Determinar si es binario o ASCII
                    const header = new TextDecoder().decode(buffer.slice(0, 5));
                    
                    if (header.toLowerCase().startsWith('solid')) {
                        resolve(parseASCIISTL(buffer));
                    } else {
                        resolve(parseBinarySTL(buffer));
                    }
                } catch (error) {
                    reject(new Error('Formato STL no v√°lido'));
                }
            });
        }

        function parseBinarySTL(buffer) {
            const view = new DataView(buffer);
            const triangleCount = view.getUint32(80, true);
            
            const vertices = [];
            const normals = [];
            
            let minX = Infinity, minY = Infinity, minZ = Infinity;
            let maxX = -Infinity, maxY = -Infinity, maxZ = -Infinity;
            
            let offset = 84;
            
            for (let i = 0; i < triangleCount; i++) {
                // Leer normal
                const nx = view.getFloat32(offset, true);
                const ny = view.getFloat32(offset + 4, true);
                const nz = view.getFloat32(offset + 8, true);
                offset += 12;
                
                // Leer 3 v√©rtices del tri√°ngulo
                for (let j = 0; j < 3; j++) {
                    const x = view.getFloat32(offset, true);
                    const y = view.getFloat32(offset + 4, true);
                    const z = view.getFloat32(offset + 8, true);
                    
                    vertices.push(x, y, z);
                    normals.push(nx, ny, nz);
                    
                    // Actualizar bounds
                    minX = Math.min(minX, x);
                    minY = Math.min(minY, y);
                    minZ = Math.min(minZ, z);
                    maxX = Math.max(maxX, x);
                    maxY = Math.max(maxY, y);
                    maxZ = Math.max(maxZ, z);
                    
                    offset += 12;
                }
                
                offset += 2; // Skip attribute count
            }
            
            return {
                vertices,
                normals,
                triangleCount,
                bounds: { minX, minY, minZ, maxX, maxY, maxZ }
            };
        }

        function parseASCIISTL(buffer) {
            const text = new TextDecoder().decode(buffer);
            const lines = text.split('\n');
            
            const vertices = [];
            const normals = [];
            
            let minX = Infinity, minY = Infinity, minZ = Infinity;
            let maxX = -Infinity, maxY = -Infinity, maxZ = -Infinity;
            
            let currentNormal = [0, 0, 1];
            let triangleCount = 0;
            
            for (const line of lines) {
                const trimmed = line.trim();
                
                if (trimmed.startsWith('facet normal')) {
                    const parts = trimmed.split(' ');
                    currentNormal = [
                        parseFloat(parts[2]) || 0,
                        parseFloat(parts[3]) || 0,
                        parseFloat(parts[4]) || 1
                    ];
                } else if (trimmed.startsWith('vertex')) {
                    const parts = trimmed.split(' ');
                    const x = parseFloat(parts[1]);
                    const y = parseFloat(parts[2]);
                    const z = parseFloat(parts[3]);
                    
                    vertices.push(x, y, z);
                    normals.push(...currentNormal);
                    
                    minX = Math.min(minX, x);
                    minY = Math.min(minY, y);
                    minZ = Math.min(minZ, z);
                    maxX = Math.max(maxX, x);
                    maxY = Math.max(maxY, y);
                    maxZ = Math.max(maxZ, z);
                    
                    if (vertices.length % 9 === 0) {
                        triangleCount++;
                    }
                }
            }
            
            return {
                vertices,
                normals,
                triangleCount,
                bounds: { minX, minY, minZ, maxX, maxY, maxZ }
            };
        }

        function calculateStats(geometry) {
            const bounds = geometry.bounds;
            const width = (bounds.maxX - bounds.minX).toFixed(1);
            const height = (bounds.maxY - bounds.minY).toFixed(1);
            const depth = (bounds.maxZ - bounds.minZ).toFixed(1);
            const volume = ((bounds.maxX - bounds.minX) * 
                          
